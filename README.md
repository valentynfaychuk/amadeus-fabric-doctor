# Amadeus Fabric Doctor

CLI tool for migrating and inspecting Amadeus blockchain databases (RocksDB).

## Quick Start

```bash
cargo build --release
./target/release/amadeus-fabric-doctor --help
```

## Database Snapshots

Download latest database snapshot:
```bash
wget https://snapshots.amadeus.bot/000034076355.zip
unzip 000034076355.zip
```

## Migration Commands

### Full Migration (Recommended)
Migrates contractstate, sysconf, entries, mutations, and consensus data.
```bash
./amadeus-fabric-doctor --db-path /source/db --migrate /target/db
```

**What gets migrated:**
- contractstate (full)
- sysconf (full)
- entry + entry_meta (temporal to rooted + chain to genesis, max 1000 entries)
- muts/muts_rev (temporal entries only)
- consensus (temporal entries only)
- attestations (skipped - regenerated by node)

### Quick State Migration
Migrates only contractstate and sysconf (fastest).
```bash
./amadeus-fabric-doctor --db-path /source/db --weakmigrate /target/db
```

## Inspection Commands

### List Contract State Keys
```bash
./amadeus-fabric-doctor --db-path /path/to/db --list-keys
```

### Get Specific Value
```bash
./amadeus-fabric-doctor --db-path /path/to/db --key <hex_key>
```

### Export All Data
```bash
./amadeus-fabric-doctor --db-path /path/to/db --export output.json
```

### Show Blockchain Tips
```bash
./amadeus-fabric-doctor --db-path /path/to/db --tips
```

### Test Entry Integrity
```bash
./amadeus-fabric-doctor --db-path /path/to/db --test results.json
```

## Installation

**Ubuntu/Debian:**
```bash
sudo apt-get install -y build-essential cmake libclang-dev \
  libsnappy-dev liblz4-dev libzstd-dev zlib1g-dev libbz2-dev
cargo build --release
```

**macOS:**
```bash
brew install cmake llvm snappy lz4 zstd
cargo build --release
```

## Column Families

| Name | Description | Migrated by --weakmigrate |
|------|-------------|---------------------------|
| entry | Blockchain entries (vecpak) | No |
| entry_meta | Entry metadata/indexes | No |
| attestation | Attestations/consensus | No |
| contractstate | Smart contract state | Yes |
| sysconf | System configuration | Yes |
| tx | Transaction pointers | No |

## Key Formats

Keys are automatically decoded for display:
- Balances: `bic:coin:balance:{Base58PubKey}:AMA`
- Nonces: `bic:base:nonce:{Base58PubKey}`
- Epoch data: `bic:epoch:trainers:height:000000319557`

## Common Workflows

**Migrate production database:**
```bash
./amadeus-fabric-doctor --db-path /old/db --migrate /new/db
./amadeus-fabric-doctor --db-path /new/db --tips
```

**Quick inspection:**
```bash
./amadeus-fabric-doctor --db-path /path/to/db --list-keys | head -20
./amadeus-fabric-doctor --db-path /path/to/db --export dump.json
```
